{% import "views/_helper.njk" as docs %}
{% import "views/_im.njk" as im %}

{{ docs.defaultLang('js') }}

# 即时通讯开发指南 &middot; 进阶功能

## 阅前准备

建议先按照顺序阅读如下文档之后，再阅读本文效果最佳：

- [即时通信服务总览](realtime_v2.html)
- [即时通讯开发指南 &middot; 基础入门](realtime-guide-beginner.html)

## 对话属性

对话是即时通信的核心逻辑对象，它有一些内置的常用的属性：

对话实例（Conversation）与控制台中 _Conversation 表是一一对应的，默认提供的属性的对应关系如下：

{{ docs.langSpecStart('js') }}

| Conversation 属性名      | _Conversation 字段 | 含义                        |
| --------------------- | ---------------- | ------------------------- |
| `id`                  | `objectId`       | 全局唯一的 Id                  |
| `name`                | `name`           | 成员共享的统一的名字                |
| `members`             | `m`              | 成员列表                      |
| `creator`             | `c`              | 对话创建者                     |
| `transient`           | `tr`             | 是否为聊天室（暂态对话）              |
| `system`              | `sys`            | 是否为服务号（系统对话）                   |
| `mutedMembers`        | `mu`             | 静音该对话的成员                  |
| `muted`               | N/A              | 当前用户是否静音该对话               |
| `createdAt`           | `createdAt`      | 创建时间                      |
| `updatedAt`           | `updatedAt`      | 最后更新时间                    |
| `lastMessageAt`       | `lm`             | 最后一条消息发送时间，也可以理解为最后一次活跃时间 |
| `lastMessage`         | N/A              | 最后一条消息，可能会空               |
| `unreadMessagesCount` | N/A              | 未读消息数                     |
| `lastDeliveredAt`     | N/A              | （仅限单聊）最后一条已送达对方的消息时间 |
| `lastReadAt`          | N/A              | （仅限单聊）最后一条对方已读的消息时间 |

{{ docs.langSpecEnd('js') }}

{{ docs.langSpecStart('objc') }}

| AVIMConversation 属性名 | _Conversation 字段 | 含义           |
| -------------------- | ---------------- | ------------ |
| `conversationId`     | `objectId`       | 全局唯一的 Id     |
| `name`               | `name`           | 成员共享的统一的名字   |
| `members`            | `m`              | 成员列表         |
| `creator`            | `c`              | 对话创建者        |
| `attributes`         | `attr`           | 自定义属性        |
| `transient`          | `tr`             | 是否为聊天室（暂态对话） |
| `createdAt`           | `createdAt`      | 创建时间                      |
| `updatedAt`           | `updatedAt`      | 最后更新时间                    |
| `system`              | `sys`            | 是否为系统对话                   |
| `lastMessageAt`       | `lm`             | 最后一条消息发送时间，也可以理解为最后一次活跃时间 |
| `lastMessage`         | N/A              | 最后一条消息，可能会空               |
| `muted`               | N/A              | 当前用户是否静音该对话               |
| `unreadMessagesCount` | N/A              | 未读消息数                     |
| `lastDeliveredAt`     | N/A              | （仅限单聊）最后一条已送达对方的消息时间 |
| `lastReadAt`          | N/A              | （仅限单聊）最后一条对方已读的消息时间 |

{{ docs.langSpecEnd('objc') }}

{{ docs.langSpecStart('java') }}

| AVIMConversation 属性名 | _Conversation 字段 | 含义                       |
| -------------------- | ---------------- | ------------------------ |
| `conversationId`     | `objectId`       | 全局唯一的 Id                 |
| `name`               | `name`           | 成员共享的统一的名字               |
| `members`            | `m`              | 成员列表                     |
| `creator`            | `c`              | 对话创建者                    |
| `attributes`         | `attr`           | 自定义属性                    |
| `isTransient`        | `tr`             | 是否为聊天室（暂态对话）             |
| `lastMessageAt`      | `lm`             | 该对话最后一条消息，也可以理解为最后一次活跃时间 |
| `lastMessage`         | N/A              | 最后一条消息，可能会空               |
| `muted`               | N/A              | 当前用户是否静音该对话               |
| `unreadMessagesCount` | N/A              | 未读消息数                     |
| `lastDeliveredAt`     | N/A              | （仅限单聊）最后一条已送达对方的消息时间 |
| `lastReadAt`          | N/A              | （仅限单聊）最后一条对方已读的消息时间 |
| `createdAt`           | `createdAt`      | 创建时间                      |
| `updatedAt`           | `updatedAt`      | 最后更新时间                    |
| `system`              | `sys`            | 是否为系统对话                   |

{{ docs.langSpecEnd('java') }}

### 拓展自定义属性


```js
```
```objc
```
```java
```
```cs
```

### 使用和修改属性

以 `conversation.name` 为例，对话的 `conversation.name` 的属性是所有成员共享的，在获取对话列表的时候，对话的名字一般会被显示在列表中，采用如下代码可以获取指定的属性，用作后续绑定列表的需求：

```js
```
```objc
```
```java
```
```cs
```

## 对话类型（聊天模式）

在[即时通讯开发指南 &middot; 基础入门](realtime-guide-beginner.html)中介绍了两种通用的对话类型：

- 一对一单聊
- 群聊

而在实际的应用场景中还有更多要进一步细化的对话类型：

- 社交软件中的私聊
- 办公聊天频道
- 同学/同事的群聊
- 游戏公会/帮派群聊
- 文字直播/聊天室
- 副本/战斗聊天
- 系统广播/游戏 GM 的全服广播
- 在线客服聊天

以及更多可能的场景都会使用到不同的对话类型，因此我们从场景出发，以实际需求对应的对话类型来讲解如何拓展出符合自己需求的对话类型。

### 基础类型

在 SDK 中已经默认提供了以下四种对话类型：

- 普通对话 `AVIMConversation`
- 聊天室 `AVIMChatRoom`
- 服务号 & 系统账号 `AVIMServiceConversation`
- 临时对话 `AVIMTemporaryConversation`


首先我们通过下面的表格来归类，更加直观地展现不同需求对应的基础类型：

对应场景|基础类型|特征备注
--|--|--
社交私聊|普通对话|成员数量恒定为 2
同学/同事群聊|`AVIMConversation`|成员数量不定，并且对话本身持久化存储
游戏公会/帮派群聊|`AVIMConversation`|与同学/同事群聊类似
文字直播/聊天室|`AVIMChatRoom`|成员数量变化频率较高，消息数量较大，消息频率/峰值变化明显
副本/战斗聊天|`AVIMChatRoom`|与文字直播/聊天室类似
系统广播/GM 全服广播|`AVIMServiceConversation`|用户订阅了对话之后才会收到消息
在线客服聊天|`AVIMTemporaryConversation`|不占用持久化存储资源，对话生命周期仅存在于使用期间

**注意：对话模型不仅仅是应对上述的场景，开发者可以根据自己实际场景的需要从上述的类型中选择一种进行拓展。**

### 普通对话

普通对话 `AVIMConversation` 有一个典型用例：

[即时通讯开发指南 &middot; 基础入门#一对一单聊](realtime-guide-beginner.html#一对一单聊)中介绍了如何建立一个一对一单聊，实际上这种单聊已经对应到了社交软件中的私聊，因为对话里面只有两个成员，如果在之后的操作中能确保**不会向当前对话继续添加新成员**，这个对话就可以用以应对社交聊天中的私聊场景。

此处需要注意如下事项：

- 假设 A 和 B 想要同时与 C 在一个对话进行聊天，此时最佳的使用方式是创建一个全新的对话，包含 A、B、C。
- 假设 A 重新登录之后，想要获取与 B 的私聊，可以通过创建对话的接口，传入一个 `isUnique` 为 true 即可，这个参数的含义是：如果 A 和 B 已经存在一个私聊，就会直接返回这个对话的 Id，而如果不存在，则会创建一个全新的对话返回，无需先查询再创建。

#### 普通对话实例 - 同学/同事群组

创建一个对话，邀请超过 3 个成员，一起加入对话：

```js
```
```objc
```
```java
```
```cs
```

修改对话名称为 `三年二班同学群`：

```js
```
```objc
```
```java
```
```cs
```

其他同学可以通过名字来找到这个对话：

```js
```
```objc
```
```java
```
```cs
```

查找之后可以直接加入：

```js
```
```objc
```
```java
```
```cs
```

也可以通过接口直接邀请目标用户加入对话：

```js
```
```objc
```
```java
```
```cs
```

### 聊天室

聊天室和普通对话有如下区别：

1. 无人数限制（而普通对话最多允许 500 人加入）
2. 从实际经验来看，为避免过量消息刷屏而影响用户体验，我们建议每个聊天室的上限人数控制在 5000 人左右。开发者可以考虑从应用层面将大聊天室拆分成多个较小的聊天室。
3. 不支持查询成员列表，但可以通过相关 API 查询在线人数。
4. 不支持离线消息、离线推送通知、消息回执等功能。
5. 没有成员加入、成员离开的通知。
6. 一个用户一次登录只能加入一个聊天室，加入新的聊天室后会自动离开原来的聊天室。
7. 加入后半小时内断网重连会自动加入原聊天室，超过这个时间则需要重新加入

所以开发者可以根据上述特性比对实际需求来选择对话类型来构建自己的业务场景。

####  聊天室实例 - 文字直播/聊天室

```js
```
```objc
```
```java
```
```cs
```

### 服务号（系统账号）

服务号和系统账号在即时通信服务里面是同一个概念。

服务号和普通对话有如下区别：

1. 服务号的订阅必须确保是由服务端发起，而客户端可以通过访问服务端的 API 去订阅一个服务号
2. 在服务号里，既可以给所有订阅者发送消息，也可以单独某一个或者某几个用户发消息


####  服务号实例 - 企业公众号

创建 LeanCloud 企业公众号：

```js
```
```objc
```
```java
```
```cs
```

订阅该公众号：


### 临时对话

#### 临时对话实例 - 电商在线客服

## 对话查询

## 对话的有效期

一个对话（包括普通、暂态、系统对话）如果 1 年内没有通过 SDK 或者 REST API 发送过新的消息，或者它在 _Conversation 表中的任意字段没有被更新过，即被视为不活跃对话，云端会自动将其删除。（查询对话的消息记录并不会更新 _Conversation 表，所以只查询不发送消息的对话仍会被视为不活跃对话。）
+

不活跃的对话被删除后，当客户端再次通过 SDK 或 REST API 对其发送消息时，会遇到 4401 INVALID_MESSAGING_TARGET 错误，表示该对话已经不存在了。同时，与该对话相关的消息历史也无法获取。

### 性能优化建议

#### 对话的查询和存储

在一些常见的需求中，进入对话列表界面的时候，客户端需要展现一个当前用户所参与的所有对话，一般情况下是按照活跃时间逆序排列在首页，因此给出一个查询优化的建议：

- 查询的时候可以尽量提供了一个 `updatedAt` 或者 `lastMessageAt` 的参数来限定返回结果
- 使用 `m` 列的 `contains` 查询来查找包含某人的对话时，也尽量使用默认的 limit 大小 10，再配合 `updatedAt` 或者 `lastMessageAt` 来做条件约束，性能会提升较大
- 整个应用对话如果数量太多，可以考虑在云引擎封装一个云函数，用定时任务启动之后，周期性地做一些清理，例如可以归档一些不活跃的对话，直接删除即可。


## 消息类型

### 音频消息

### 视频消息

### 文件消息

### 自定义消息类型

如果遇到了有强需求的自定义消息，我们推荐按照如下需求分级，来选择自定义的方式：

### 消息发送选项

### @ 成员提醒

### 消息的撤回和修改

### 客户端消息缓存与重发

### 消息的离线推送通知

## 消息记录

{{ docs.relatedLinks("更多文档",[
  { title: "服务总览", href: "realtime_v2.html" },
  { title: "基础入门", href: "realtime-guide-beginner.html" }, 
  { title: "高阶技巧", href: "/realtime-guide-senior.html"}])
}}