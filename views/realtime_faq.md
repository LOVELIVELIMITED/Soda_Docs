{% import "views/_im.njk" as im %}
# 即时通讯服务常见错误一览

## 云端错误码说明

即时通讯的错误码会以 SDK 异常或 WebSocket 关闭状态码的形式返回给客户端。当出现异常情况时，SDK 会输出状态码到日志里，以下是对部分状态码的简单说明：

{{ im.errorCodes('table') }}

## 常见问题 FAQ

### 要让单个群组消息进入「免打扰模式」，该如何做

对于普通对话的新消息，LeanCloud 即时通讯服务有选项支持将消息以 Push Notification 的方式通知当前不在线的成员，但是有时候，这种推送会非常频繁对用户造成干扰。LeanCloud 提供选项，支持让单个用户关闭特定对话的离线消息推送。具体可以看相应平台的开发指南文档。


### 聊天好友关系如何实现

LeanCloud 即时通讯服务是完全独立的即时通讯业务抽象，专注在即时通讯本身，所以即时通讯的业务逻辑中，并不含有好友关系，以及对应的聊天用户数据信息（如头像、名称等）。即时通讯与其他业务逻辑完全隔离，不耦合，唯一关联的就是 clientId。这样做的好处是显而易见的，比如你可以很容易让匿名用户直接通信，你也可以自定义一些好友逻辑，总之可以做成因为任意逻辑而匹配产生的聊天行为。

当然，如果你想维护一套好友关系，完全可以使用你自己的逻辑，只要存储着每个用户在即时通讯中的 clientId 即可。我们推荐使用 LeanCloud 的存储，即 LeanStorage，这样可以结合 LeanCloud 中的 User 相关对象来简单地实现账户系统，以及与之相关的存储，详情可以阅读对应的 SDK 开发指南。

### 聊天记录的保存时间和条数

{{ im.messagesLifespan("") }}

### 聊天消息没有收到

当出现聊天消息没有收到的情况，你可以按照以下思路排查：

* 调用消息记录 API 查看消息是否到达了云端
* 如果只有一个消息接收者，可以检查消息记录中对应条目的 `ack-at` 字段判断消息是否到达了客户端
{% if node=='qcloud' %}
* 在 `控制台 > **消息** > **实时消息** > **帮助**` 页面的文本框里输入对应的 Client ID，查看是否在线，以及是否有离线消息。
{% else %}
* 在 [控制台 > **消息** > **实时消息** > **帮助**](/messaging.html?appid={{appid}}#/message/realtime/tool) 页面的文本框里输入对应的 Client ID，查看是否在线，以及是否有离线消息。
{% endif %}


### 为什么我的 iPhone 收不到离线消息推送
{% if node=='qcloud' %}
请先参考 [聊天消息没有收到](#聊天消息没有收到)。在 `控制台 > **消息** > **实时消息** > **设置** > **离线推送设置** > **推送内容**`
{% else %}
请先参考 [聊天消息没有收到](#聊天消息没有收到)。在 [控制台 > **消息** > **实时消息** > **设置** > **离线推送设置** > **推送内容**](/messaging.html?appid={{appid}}#/message/realtime/conf) {% endif %}
填写「您有新的未读消息」后，当对方不在线的时候，便会触发一个 APNs 的推送。首先，请确保控制台能向 iOS 推送消息，也即如下图所示的推送能顺利到达 iOS 系统，请参考 [iOS 推送开发文档](ios_push_guide.html)。

![image](images/realtime_faq_push.png)

之后，还要确保对方确实是离线，如果对方程序在前台并且网络良好，则不会触发推送。如果对方网络未连接，则下次联网的时候收到回调，也不触发推送。也可以利用控制台实时消息页的用户状态查询来确保对方处于离线状态，如下图。

![image](images/realtime_faq_console.png)

离线消息推送默认用的是生产环境编辑框里上传的证书。所以，调试时可能要上传开发证书，并在推送内容中设置 `_profile` 属性来选择开发证书推送，如 `{"alert": "你有一条未读消息", "_profile": "dev"}`

检查方法总结如下：

* 检查 `_Installation` 表中是否有设备订阅了对应的 Client ID
* 检查普通的 iOS 推送是否到达
* 检查证书设置
* 在控制台检查接收方是否在离线状态

### Android 设备系统时间不准，会影响即时通讯服务吗？

可能会，取决于证书的时间。当错误的系统时间和当前时间的误差，大于证书的有效时间，就会导致 SSL 握手失败，进而让即时通讯服务整体不可用。
